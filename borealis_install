#!bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

sudo systemctl stop BOREALIS_CAM.service            #Remove old installation of BOREALIS_Cam
sudo rm -rf /home/$USER/BOREALIS_Cam
sudo rm /etc/systemd/system/BOREALIS_CAM.service

#Prompts for and checks for proper MAC address
while true; do

	echo -e " \n"
	echo -e "\n\n\nPlease enter the MAC address of your ground station laptop\nin the form XX:XX:XX:XX:XX:XX(Colon Separated)\n"
	read mac_in
    if [[ $mac_in =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]; then
    	echo -e "${GREEN}Valid MAC address: $mac_in${NC}"
    	break;
    else
        echo -e "\n${RED}Invalid MAC address (Incorrect Form or Values)${NC}"
    fi

done

#Prompts for and checks for proper IP address
while true; do

    echo -e "\nPlease enter the IP address of your ground station laptop\nin the form XXX.XXX.XXX.XXX(Period Separated)\n"
    read ip_in
    if [[ $ip_in =~ ^([1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$ ]]; then
    	echo -e "${GREEN}Valid IP address: $ip_in${NC}"
        break;
    else 
        echo -e "\n${RED}IP Incorrect(Incorrect Form or Values)${NC}"
    fi

done

git clone -b pi5 https://github.com/25nlambert/BOREALIS_Cam.git #Clone git repository of files

# Run the list cameras and count the lines
num_cameras=$(rpicam-hello --list-cameras | wc -l )

if [ "$num_cameras" -gt 7 ]; then #Check if lines longer than 7
    echo "More than one camera is connected."
    multiple_cams=1
else
    echo "Only one camera is connected."
    multiple_cams=0
    sudo cp BOREALIS_Cam/config.txt /boot/config.txt #Replace config file with camera one
fi

line_with_multicam=$(grep "^multiple_cams" BOREALIS_Cam/config.conf)
sed -i "s/$line_with_multicam/multiple_cams=$multiple_cams/" BOREALIS_Cam/config.conf #Saves to config

sudo apt purge avahi-daemon modemmanager pipwire-bin packagekit pipewire libnss-mdns cups cups-browsed chromium-browser #Delete unnecessary processes

sudo apt update     #Update operating system
sudo apt -y upgrade

source /home/$USER/BOREALIS_Cam/config.conf #Reload config

sed -i "s/$GSip/$ip_in/" BOREALIS_Cam/config.conf #Saves to config
sed -i "s/$GSmac/$mac_in/" BOREALIS_Cam/config.conf #Saves to config

find_third_octet=$(echo "$ip_in" | awk -F "." '{print $3}') #Find third_octet for subnet
line_with_third_octet=$(grep "^third_octet" BOREALIS_Cam/config.conf)
sed -i "s/$line_with_third_octet/third_octet=$find_third_octet/" BOREALIS_Cam/config.conf #Saves to config

install_date="#install_date=$(date)" #Takes note of the time of installation
sed -i "2c$install_date" BOREALIS_Cam/config.conf

source /home/$USER/BOREALIS_Cam/config.conf #Reload config

sed -i "s/$ip/192.168.$third_octet.23/" BOREALIS_Cam/config.conf #Saves to config

sudo systemctl enable ssh #Enable SSH
sudo systemctl start ssh

sudo systemctl stop cups.service cups-browsed.service bluetooth.service hciuart.service #Turn off unnecessary services
sudo systemctl disable cups.service cups-browsed.service bluetooth.service hciuart.service
sudo systemctl mask bluetooth.service hciuart.service

sudo apt install -y vim vim-runtime vim-common #Install Vim because we can

sudo apt install -y tcpdump #So I can take a network dump

#Set Static IP
sudo nmcli connection add con-name staticip ifname eth0 type ethernet ip4 192.168.$third_octet.23/24

sudo cp BOREALIS_Cam/.bashrc /home/$USER/.bashrc #Replace shell config

#Modify service with correct directory
sed -i "s/pi/$USER/" BOREALIS_Cam/BOREALIS_CAM0.service
sed -i "s/pi/$USER/" BOREALIS_Cam/BOREALIS_CAM1.service

sudo cp BOREALIS_Cam/BOREALIS_CAM0.service /etc/systemd/system #Copy service file
sudo cp BOREALIS_Cam/BOREALIS_CAM1.service /etc/systemd/system #Copy service file

sudo chmod +x /home/$USER/BOREALIS_Cam/cam0_start_stream
sudo chmod +x /home/$USER/BOREALIS_Cam/cam1_start_stream
sudo chmod +x /home/$USER/BOREALIS_Cam/edit_stream

sudo systemctl enable BOREALIS_CAM0.service
sudo systemctl enable BOREALIS_CAM1.service

sudo apt autoremove -y

sudo reboot
