#!bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

#Prompts for and checks for proper MAC address
while true; do

	echo -e " \n"
	echo -e "\n\n\nPlease enter the MAC address of your ground station laptop\nin the form XX:XX:XX:XX:XX:XX(Colon Separated)\n"
	read MAC
    if [[ $MAC =~ ^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$ ]]; then
    	echo -e "${GREEN}Valid MAC address: $MAC${NC}"
    	break;
    else
        echo -e "\n${RED}Invalid MAC address (Incorrect Form or Values)${NC}"
    fi

done

#Prompts for and checks for proper IP address
while true; do

    echo -e "\nPlease enter the IP address of your ground station laptop\nin the form XXX.XXX.XXX.XXX(Period Separated)\n"
    read IP
    if [[ $IP =~ ^([1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.([1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$ ]]; then
    	echo -e "${GREEN}IP Correct: $IP${NC}"
        break;
    else 
        echo -e "\n${RED}IP Incorrect(Incorrect Form or Values)${NC}"
    fi

done

sudo apt update

sudo apt -y upgrade

command5_output=$(git clone https://github.com/25nlambert/BOREALIS_Cam.git)
echo "$command5_output"

sudo dpkg -i BOREALIS_Cam/libcamera0_0~git20230707+2783c8d8-1_arm64.deb #Install modified libcamera

sudo arp -S $IP $MAC #Set ARP mac address for ground laptop

sudo systemctl enable ssh #Enable SSH
sudo systemctl start ssh

sudo systemctl stop cups.service cups-browsed.service bluetooth.service hciuart.service #Turn off unnecessary services
sudo systemctl disable cups.service cups-browsed.service bluetooth.service hciuart.service
sudo systemctl mask bluetooth.service hciuart.service

sudo apt purge avahi-daemon modemmanager pipwire-bin packagekit pipewire libnss-mdns cups cups-browsed #Delete unnecessary processes

sudo apt install -y vim vim-runtime vim-common #Install Vim because we can

sudo apt install -y tcpdump #So I can take a network dump

sudo cp BOREALIS_Cam/config.txt /boot/config.txt #Replace config file with camera one

#Finding and replacing to get on correct subnet
third_octet=$(echo "$IP" | awk -F "." '{print $3}') #Find third_octet for subnet
cp ./BOREALIS_Cam/dhcpcd.conf ./BOREALIS_Cam/dhcpcd.conf.modify #Create duplicate to modify
sed "s/XX.XX.XX.XX/192.168.$third_octet.23/" <./BOREALIS_Cam/dhcpcd.conf.modify >./BOREALIS_Cam/dhcpcd.conf.modified #modify duplicate
sudo cp ./BOREALIS_Cam/dhcpcd.conf.modified /etc/dhcpcd.conf 								#Replace dhcp file with working one for static IP
rm ./BOREALIS_Cam/dhcpcd.conf.modify ./BOREALIS_Cam/dhcpcd.conf.modified				#remove duplicates

#Modify start_stream with correct IP
cp BOREALIS_Cam/start_stream BOREALIS_Cam/start_stream.modify #Create duplicate to modify
sed "s/XX.XX.XX.XX/$IP/" <./BOREALIS_Cam/start_stream.modify >./BOREALIS_Cam/start_stream.modified #modify duplicate
sudo cp BOREALIS_Cam/start_stream.modified BOREALIS_Cam/start_stream 								#Replace start_stream file with working one for static IP
rm ./BOREALIS_Cam/start_stream.modify ./BOREALIS_Cam/start_stream.modified				#remove duplicates

sudo cp BOREALIS_Cam/.bashrc /home/pi/.bashrc #Replace shell config

sudo cp BOREALIS_Cam/BOREALIS_CAM.service /etc/systemd/system #Copy service file

sudo chmod +x /home/pi/BOREALIS_Cam/start_stream
sudo chmod +x /home/pi/BOREALIS_Cam/edit_stream

sudo systemctl enable BOREALIS_CAM.service

sudo apt autoremove -y

sudo reboot
